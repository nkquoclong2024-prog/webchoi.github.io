<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhân Tướng Học AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: sans-serif;
        }
        .hidden {
            display: none;
        }
        @keyframes scan {
          0% { top: 0%; opacity: 0; }
          10% { opacity: 1; }
          90% { opacity: 1; }
          100% { top: 100%; opacity: 0; }
        }
        .animate-scan {
          animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(30px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 selection:bg-purple-500 selection:text-white pb-10">

    <div id="app">
        <!-- Header -->
        <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
            <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-tr from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                        <i data-lucide="brain" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-indigo-400 hidden sm:block">
                        Nhân Tướng Học AI
                    </h1>
                </div>
                
                <div class="flex bg-slate-800 p-1 rounded-lg">
                    <button id="single-mode-btn" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-slate-700 text-white shadow-sm">
                        Cá Nhân
                    </button>
                    <button id="couple-mode-btn" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-slate-200">
                        Tướng Phu Thê
                    </button>
                    <button id="tarot-mode-btn" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-slate-200">
                        Tarot
                    </button>
                </div>

                <button id="reset-btn" class="p-2 text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <div id="intro-section" class="text-center mb-12 animate-fade-in-up">
                <!-- Intro content will be injected by JS -->
            </div>

            <div id="error-section" class="hidden bg-red-500/10 border border-red-500/50 text-red-200 p-4 rounded-lg mb-6 max-w-xl mx-auto animate-fade-in items-center gap-2">
                <i data-lucide="alert-circle" class="w-5 h-5 shrink-0"></i>
                <p id="error-message"></p>
            </div>

            <div id="main-interface" class="hidden grid lg:grid-cols-2 gap-8 items-start">
                <div id="images-container" class="grid gap-4 grid-cols-1">
                    <!-- Image holders will be injected by JS -->
                </div>
                <div id="results-container" class="space-y-6">
                    <!-- Results will be injected by JS -->
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="file-input-1" class="hidden" accept="image/*">
    <input type="file" id="file-input-2" class="hidden" accept="image/*">

    <script>
        // --- CONFIGURATION ---
        const apiKey = "AIzaSyAlOsIKtaw_4AlvScqIHH0dbym6azqoVMs";

        // --- DOM ELEMENTS ---
        const app = document.getElementById('app');
        const introSection = document.getElementById('intro-section');
        const errorSection = document.getElementById('error-section');
        const errorMessage = document.getElementById('error-message');
        const mainInterface = document.getElementById('main-interface');
        const imagesContainer = document.getElementById('images-container');
        const resultsContainer = document.getElementById('results-container');
        const singleModeBtn = document.getElementById('single-mode-btn');
        const coupleModeBtn = document.getElementById('couple-mode-btn');
        const tarotModeBtn = document.getElementById('tarot-mode-btn');
        const resetBtn = document.getElementById('reset-btn');
        const fileInput1 = document.getElementById('file-input-1');
        const fileInput2 = document.getElementById('file-input-2');

        // --- STATE MANAGEMENT ---
        let state = {
            mode: 'single', // 'single', 'couple', or 'tarot'
            imageFile1: null,
            imageFile2: null,
            isScanning: false,
            scanProgress: 0,
            result: null,
            error: null,
            loadingText: "Đang khởi tạo AI...",
            // Tarot state
            tarotQuestion: '',
            drawnCards: [],
            tarotResult: null,
            isDrawing: false,
        };

        // --- RENDER FUNCTIONS ---
        const render = () => {
            // Render Mode Switcher
            singleModeBtn.className = `px-4 py-1.5 rounded-md text-sm font-medium transition-all ${state.mode === 'single' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`;
            coupleModeBtn.className = `px-4 py-1.5 rounded-md text-sm font-medium transition-all ${state.mode === 'couple' ? 'bg-gradient-to-r from-pink-600 to-purple-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`;
            tarotModeBtn.className = `px-4 py-1.5 rounded-md text-sm font-medium transition-all ${state.mode === 'tarot' ? 'bg-gradient-to-r from-amber-600 to-yellow-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`;
            
            // Render Error
            if (state.error) {
                errorSection.classList.remove('hidden');
                errorSection.classList.add('flex');
                errorMessage.textContent = state.error;
            } else {
                errorSection.classList.add('hidden');
                errorSection.classList.remove('flex');
            }

            if (state.mode === 'tarot') {
                mainInterface.classList.add('hidden');
                introSection.classList.remove('hidden');
                renderTarot();
            } else {
                const noImagesUploaded = !state.imageFile1;
                introSection.classList.toggle('hidden', !noImagesUploaded);
                mainInterface.classList.toggle('hidden', noImagesUploaded);

                if (noImagesUploaded) {
                    renderIntro();
                } else {
                    renderMainInterface();
                }
            }
            
            // Activate icons
            lucide.createIcons();
        };

        const renderIntro = () => {
            const isSingle = state.mode === 'single';
            const title = isSingle 
                ? `Khám phá vận mệnh qua <span class="text-purple-400">Gương Mặt</span>`
                : `Đo độ hợp nhau qua <span class="text-pink-400">Tướng Phu Thê</span>`;
            
            const description = isSingle
                ? "Hệ thống AI sẽ phân tích ngũ quan để dự đoán tính cách, tài lộc và sự nghiệp."
                : "Tải lên ảnh của bạn và người ấy. AI sẽ so sánh mức độ hòa hợp về tướng số và tình duyên.";

            const uploadBox1 = `
                <div onclick="fileInput1.click()" class="border-2 border-dashed border-slate-700 bg-slate-900/50 hover:bg-slate-800/50 hover:border-purple-500 transition-all cursor-pointer rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group h-64 relative overflow-hidden">
                    <div class="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300 relative z-10">
                        <i data-lucide="user" class="w-7 h-7 text-purple-400"></i>
                    </div>
                    <div class="text-center relative z-10">
                        <p class="text-lg font-medium text-white mb-1">${isSingle ? "Tải ảnh chân dung" : "Ảnh Bạn"}</p>
                        <p class="text-xs text-slate-500">JPG, PNG (Rõ mặt)</p>
                    </div>
                </div>`;
            
            const uploadBox2 = `
                <div onclick="fileInput2.click()" class="border-2 border-dashed border-slate-700 bg-slate-900/50 hover:bg-slate-800/50 hover:border-pink-500 transition-all cursor-pointer rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group h-64 relative overflow-hidden">
                    <div class="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300 relative z-10">
                        <i data-lucide="heart" class="w-7 h-7 text-pink-400"></i>
                    </div>
                    <div class="text-center relative z-10">
                        <p class="text-lg font-medium text-white mb-1">Ảnh Người Ấy</p>
                        <p class="text-xs text-slate-500">JPG, PNG (Rõ mặt)</p>
                    </div>
                </div>`;

            introSection.innerHTML = `
                <h2 class="text-3xl md:text-5xl font-bold mb-4 text-white">${title}</h2>
                <p class="text-slate-400 text-lg max-w-2xl mx-auto mb-8">${description}</p>
                <div class="grid gap-6 ${!isSingle ? 'md:grid-cols-2' : 'max-w-xl mx-auto'}">
                    ${uploadBox1}
                    ${!isSingle ? uploadBox2 : ''}
                </div>
            `;
        };

        const renderMainInterface = () => {
            imagesContainer.className = `grid gap-4 ${state.mode === 'couple' ? 'grid-cols-2' : 'grid-cols-1'}`;
            imagesContainer.innerHTML = ''; // Clear previous
            
            if (state.imageFile1) {
                const img1URL = URL.createObjectURL(state.imageFile1);
                imagesContainer.innerHTML += createImageHolder(1, img1URL);
            }
            if (state.mode === 'couple') {
                const img2URL = state.imageFile2 ? URL.createObjectURL(state.imageFile2) : null;
                imagesContainer.innerHTML += createImageHolder(2, img2URL);
            }

            if (state.isScanning) {
                resultsContainer.innerHTML = createSkeletonLoader();
                const scanningStatus = `
                  <div class="absolute inset-0 z-20 flex items-end justify-center pointer-events-none pb-12 lg:pb-0 lg:items-center">
                     <div class="inline-flex items-center gap-3 px-6 py-3 rounded-full bg-black/80 text-white text-sm font-mono border border-purple-500/50 backdrop-blur-md shadow-[0_0_30px_rgba(168,85,247,0.3)]">
                      <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-purple-400"></i>
                      ${state.loadingText} ${state.scanProgress}%
                    </div>
                  </div>`;
                imagesContainer.insertAdjacentHTML('beforeend', scanningStatus);

            } else if (state.result) {
                resultsContainer.innerHTML = createResultContent(state.result);
            } else {
                 resultsContainer.innerHTML = '';
            }
        };

        // --- COMPONENT CREATORS (return HTML strings) ---
        const createImageHolder = (slot, imageURL) => {
            const isSingle = state.mode === 'single';
            if (slot === 1) {
                return `
                    <div class="relative rounded-2xl overflow-hidden shadow-2xl bg-black border border-slate-700 group aspect-[3/4]">
                        <img src="${imageURL}" alt="User 1" class="w-full h-full object-cover transition-opacity duration-500 ${state.isScanning ? 'opacity-50' : 'opacity-100'}" />
                        ${state.isScanning ? createScanningOverlay(state.scanProgress, 'purple') : ''}
                    </div>`;
            }
            if (slot === 2) {
                if (imageURL) {
                     return `
                        <div class="relative rounded-2xl overflow-hidden shadow-2xl bg-black border border-slate-700 group aspect-[3/4]">
                            <img src="${imageURL}" alt="User 2" class="w-full h-full object-cover transition-opacity duration-500 ${state.isScanning ? 'opacity-50' : 'opacity-100'}" />
                             ${state.isScanning ? createScanningOverlay(state.scanProgress, 'pink') : ''}
                        </div>`;
                } else {
                    return `
                        <div class="relative rounded-2xl overflow-hidden shadow-2xl bg-black border border-slate-700 group aspect-[3/4] border-dashed flex items-center justify-center bg-slate-900 cursor-pointer" onclick="fileInput2.click()">
                            <div class="text-center p-4">
                                <i data-lucide="heart" class="w-8 h-8 text-slate-600 mx-auto mb-2"></i>
                                <p class="text-sm text-slate-400">Thêm ảnh người ấy</p>
                            </div>
                        </div>`;
                }
            }
            return '';
        };
        
        const createScanningOverlay = (progress, color = "purple") => {
            const colorClass = color === "pink" ? "bg-pink-500 shadow-[0_0_15px_rgba(236,72,153,0.8)]" : "bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.8)]";
            return `
                <div class="absolute inset-0 z-10 flex flex-col items-center justify-center">
                    <div class="absolute w-full h-1 ${colorClass} animate-scan" style="top: ${progress}%"></div>
                    <div class="absolute inset-0 ${color === "pink" ? "bg-pink-500/10" : "bg-purple-500/10"} mix-blend-overlay"></div>
                </div>`;
        };

        const createSkeletonLoader = () => `
            <div class="space-y-4 animate-pulse">
                <div class="h-24 bg-slate-900/50 rounded-2xl border border-slate-800 w-full mb-6"></div>
                ${[1, 2, 3].map(() => `
                    <div class="p-4 bg-slate-900 rounded-xl border border-slate-800">
                        <div class="h-5 bg-slate-800 rounded w-1/3 mb-3"></div>
                        <div class="h-3 bg-slate-800 rounded w-full mb-2"></div>
                        <div class="h-3 bg-slate-800 rounded w-5/6"></div>
                    </div>`).join('')}
            </div>`;

        const createResultContent = (result) => {
            const isSingle = state.mode === 'single';
            const score = isSingle ? result.score : result.compatibility_score;
            const scoreColor = isSingle ? 'text-amber-400' : 'text-pink-400';
            const scoreBg = isSingle ? 'from-amber-900/40 to-yellow-900/40 border-amber-500/30' : 'from-pink-900/40 to-purple-900/40 border-pink-500/30';
            const scoreTitle = isSingle ? "Tổng Quan Vận Mệnh" : "Chỉ Số Tướng Phu Thê";
            const scoreIcon = isSingle ? 'sparkles' : 'heart';

            let analysisContent = '';
            if (isSingle) {
                analysisContent = `
                    <div class="space-y-4">
                        ${createResultCard('brain', 'purple', "Trán & Trí Tuệ", result.forehead)}
                        ${createResultCard('eye', 'blue', "Mắt & Thần Khí", result.eyes)}
                        ${createResultCard('user', 'green', "Mũi & Tài Lộc", result.nose)}
                        ${createResultCard('heart', 'pink', "Miệng & Tình Cảm", result.mouth)}
                        <div class="mt-6 grid gap-4">
                           ${createAdviceCard('briefcase', 'indigo', "Sự Nghiệp", result.career)}
                           ${createAdviceCard('heart', 'pink', "Tình Duyên", result.love)}
                        </div>
                    </div>`;
            } else {
                analysisContent = `
                    <div class="space-y-4">
                        ${createResultCard('sparkles', 'green', "Điểm Hòa Hợp (Tương Sinh)", result.harmony_points)}
                        ${createResultCard('alert-circle', 'red', "Điểm Cần Khắc Phục", result.conflict_points)}
                        <div class="mt-6 space-y-4">
                           ${createAdviceCard('heart', 'pink', "Lời Khuyên Tình Yêu", result.love_advice)}
                           ${createAdviceCard('arrow-right', 'purple', "Dự Đoán Tương Lai", result.future_prediction)}
                        </div>
                    </div>`;
            }

            return `
                <div class="animate-fade-in space-y-4">
                    <div class="bg-gradient-to-r p-6 rounded-2xl mb-6 relative overflow-hidden border ${scoreBg}">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="sparkles" class="w-24 h-24 text-white"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2 flex items-center gap-2 relative z-10 ${scoreColor}">
                           <i data-lucide="${scoreIcon}" class="w-5 h-5"></i>
                           ${scoreTitle}
                        </h3>
                        <div class="flex items-end gap-2 relative z-10">
                           <span class="text-5xl font-bold ${scoreColor}">${score}</span>
                           <span class="text-slate-400 pb-2 text-lg">/ 100</span>
                        </div>
                        ${!isSingle ? `<p class="text-slate-300 mt-2 italic relative z-10">"${result.overview}"</p>` : ''}
                    </div>

                    ${analysisContent}

                    <div class="mt-8 text-center">
                        <button onclick="resetApp()" class="text-sm text-slate-500 hover:text-white underline">
                            Thử lại với ảnh khác
                        </button>
                    </div>
                </div>`;
        };

        const createResultCard = (icon, color, title, content) => `
            <div class="bg-slate-900/80 p-4 rounded-xl border border-slate-800 hover:border-slate-700 transition-all hover:bg-slate-800/50">
              <div class="flex items-start gap-4">
                <div class="mt-1 p-2 bg-slate-950 rounded-lg border border-slate-800 shadow-sm shrink-0">
                  <i data-lucide="${icon}" class="w-5 h-5 text-${color}-400"></i>
                </div>
                <div>
                  <h4 class="text-slate-200 font-semibold text-sm uppercase tracking-wider mb-2">${title}</h4>
                  <p class="text-slate-400 text-sm leading-relaxed">${content}</p>
                </div>
              </div>
            </div>`;

        const createAdviceCard = (icon, color, title, content) => {
            const borderColor = `border-${color}-500`;
            const textColor = `text-${color}-400`;
            return `
                <div class="bg-slate-900 p-5 rounded-xl border-l-4 ${borderColor} shadow-lg">
                  <h4 class="${textColor} font-semibold mb-2 flex items-center gap-2">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                    ${title}
                  </h4>
                  <p class="text-slate-300 text-sm leading-relaxed">${content}</p>
                </div>`;
        };

        // --- TAROT ---
        const TAROT_CARDS = {
            MajorArcana: ["The Fool", "The Magician", "The High Priestess", "The Empress", "The Emperor", "The Hierophant", "The Lovers", "The Chariot", "Strength", "The Hermit", "Wheel of Fortune", "Justice", "The Hanged Man", "Death", "Temperance", "The Devil", "The Tower", "The Star", "The Moon", "The Sun", "Judgement", "The World"],
            Wands: ["Ace of Wands", "Two of Wands", "Three of Wands", "Four of Wands", "Five of Wands", "Six of Wands", "Seven of Wands", "Eight of Wands", "Nine of Wands", "Ten of Wands", "Page of Wands", "Knight of Wands", "Queen of Wands", "King of Wands"],
            Cups: ["Ace of Cups", "Two of Cups", "Three of Cups", "Four of Cups", "Five of Cups", "Six of Cups", "Seven of Cups", "Eight of Cups", "Nine of Cups", "Ten of Cups", "Page of Cups", "Knight of Cups", "Queen of Cups", "King of Cups"],
            Swords: ["Ace of Swords", "Two of Swords", "Three of Swords", "Four of Swords", "Five of Swords", "Six of Swords", "Seven of Swords", "Eight of Swords", "Nine of Swords", "Ten of Swords", "Page of Swords", "Knight of Swords", "Queen of Swords", "King of Swords"],
            Pentacles: ["Ace of Pentacles", "Two of Pentacles", "Three of Pentacles", "Four of Pentacles", "Five of Pentacles", "Six of Pentacles", "Seven of Pentacles", "Eight of Pentacles", "Nine of Pentacles", "Ten of Pentacles", "Page of Pentacles", "Knight of Pentacles", "Queen of Pentacles", "King of Pentacles"]
        };
        const ALL_CARDS = Object.values(TAROT_CARDS).flat();

        const renderTarot = () => {
            if (state.isDrawing) {
                introSection.innerHTML = createTarotIntro(); // Keep intro visible
                mainInterface.classList.remove('hidden');
                resultsContainer.innerHTML = createSkeletonLoader();
            } else if (state.tarotResult) {
                introSection.innerHTML = createTarotResult(state.tarotResult);
                mainInterface.classList.add('hidden');
                resultsContainer.innerHTML = '';
            } else {
                introSection.innerHTML = createTarotIntro();
                mainInterface.classList.add('hidden');
            }
        };

        const createTarotIntro = () => {
            return `
                <div class="text-center mb-12 animate-fade-in-up max-w-2xl mx-auto">
                    <h2 class="text-3xl md:text-5xl font-bold mb-4 text-white">
                        Giải Mã Tarot Cùng <span class="text-amber-400">AI</span>
                    </h2>
                    <p class="text-slate-400 text-lg mx-auto mb-8">
                        Tập trung vào câu hỏi của bạn, và để vũ trụ đưa ra câu trả lời thông qua những lá bài.
                    </p>
                    <div class="space-y-4">
                        <textarea id="tarot-question-input" class="w-full bg-slate-900 border-2 border-slate-700 rounded-lg p-4 text-slate-200 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition placeholder:text-slate-500" rows="3" placeholder="Nhập câu hỏi hoặc vấn đề bạn đang bận tâm... (không bắt buộc)">${state.tarotQuestion}</textarea>
                        <button onclick="startTarotReading()" ${state.isDrawing ? 'disabled' : ''} class="bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg hover:shadow-xl hover:shadow-yellow-500/20 transform hover:-translate-y-1 transition-all duration-300 w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            ${state.isDrawing ? '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Đang Giải Bài...' : 'Rút 3 Lá Bài'}
                        </button>
                    </div>
                </div>
            `;
        }

        const createTarotResult = (result) => {
             return `
                <div class="animate-fade-in-up space-y-8 max-w-4xl mx-auto">
                    <div class="text-center">
                        <h2 class="text-3xl md:text-4xl font-bold text-amber-400">Luận Giải Trải Bài</h2>
                        <p class="text-slate-400 mt-2">Đây là thông điệp vũ trụ dành cho bạn:</p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6 text-center">
                        ${result.cards.map(card => `
                            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 flex flex-col items-center animate-fade-in" style="animation-delay: ${card.position === 'Quá khứ' ? '100ms' : card.position === 'Hiện tại' ? '300ms' : '500ms'}">
                                <div class="w-24 h-40 bg-slate-800 border-2 border-slate-700 rounded-lg flex flex-col justify-center items-center mb-4 shadow-lg bg-cover bg-center" style="background-image: url('https://via.placeholder.com/150x240/1e293b/ffffff?text=${encodeURIComponent(card.name)}')">
                                    
                                </div>
                                <h3 class="font-bold text-lg text-white">${card.name}</h3>
                                <p class="text-sm font-semibold text-amber-400 mb-2">${card.position}</p>
                                <p class="text-slate-400 text-sm leading-relaxed">${card.interpretation}</p>
                            </div>
                        `).join('')}
                    </div>

                    <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 animate-fade-in" style="animation-delay: 700ms">
                        <h4 class="text-yellow-400 font-semibold mb-2 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-5 h-5"></i>
                            Tổng Kết & Lời Khuyên
                        </h4>
                        <p class="text-slate-300 leading-relaxed">${result.summary}</p>
                    </div>

                    <div class="mt-8 text-center animate-fade-in" style="animation-delay: 900ms">
                        <button onclick="resetApp()" class="text-sm text-slate-500 hover:text-white underline">
                            Thực hiện trải bài khác
                        </button>
                    </div>
                </div>
            `;
        }

        const startTarotReading = async () => {
            const questionInput = document.getElementById('tarot-question-input');
            state.tarotQuestion = questionInput.value;
            state.isDrawing = true;
            state.tarotResult = null;
            state.error = null;
            render();

            // Draw 3 unique cards
            const shuffled = [...ALL_CARDS].sort(() => 0.5 - Math.random());
            state.drawnCards = shuffled.slice(0, 3);

            try {
                await analyzeWithGemini();
            } catch (err) {
                console.error(err);
                state.error = "AI đang bận, không thể giải bài lúc này. Xin thử lại sau.";
                state.isDrawing = false;
                render();
            }
        }


        // --- LOGIC FUNCTIONS ---
        const handleImageUpload = (e, slot) => {
            const file = e.target.files[0];
            if (file) {
                processFile(file, slot);
            }
            e.target.value = null; // Reset to allow re-uploading same file
        };

        const processFile = (file, slot) => {
            if (!file.type.startsWith('image/')) {
                state.error = "Vui lòng tải lên tệp hình ảnh hợp lệ.";
                render();
                return;
            }
            if (slot === 1) state.imageFile1 = file;
            else state.imageFile2 = file;
            
            state.error = null;
            
            const shouldStartSingle = state.mode === 'single' && state.imageFile1;
            const shouldStartCouple = state.mode === 'couple' && state.imageFile1 && state.imageFile2;

            if ((shouldStartSingle || shouldStartCouple) && !state.isScanning && !state.result) {
                 setTimeout(() => startScanning(), shouldStartCouple ? 1000 : 0);
            }
            render();
        };

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const startScanning = async () => {
            state.isScanning = true;
            state.scanProgress = 0;
            state.loadingText = state.mode === 'single' ? "Đang quét ngũ quan..." : "Đang so sánh tướng phu thê...";
            render();

            const progressInterval = setInterval(() => {
                state.scanProgress = Math.min(90, state.scanProgress + 5);
                render();
            }, 200);

            try {
                const base64Data1 = await fileToBase64(state.imageFile1);
                const base64Data2 = state.mode === 'couple' && state.imageFile2 ? await fileToBase64(state.imageFile2) : null;
                await analyzeWithGemini(base64Data1, state.imageFile1.type, state.imageFile2?.type);
            } catch (err) {
                console.error(err);
                state.error = "Có lỗi xảy ra khi xử lý ảnh. Vui lòng thử lại.";
                state.isScanning = false;
                render();
            } finally {
                clearInterval(progressInterval);
            }
        };

        const analyzeWithGemini = async (b64Img1, mime1, b64Img2, mime2) => {
            state.loadingText = "AI đang luận giải...";
            if (state.mode !== 'tarot') render();

            let prompt = "";
            const parts = [];

            if (state.mode === 'tarot') {
                prompt = `Bạn là một chuyên gia giải bài Tarot. Dựa vào câu hỏi của người dùng và ba lá bài được rút (quá khứ, hiện tại, tương lai), hãy đưa ra một bài luận giải chi tiết, sâu sắc và đầy cảm hứng.
Câu hỏi: "${state.tarotQuestion || 'Tổng quan về cuộc sống.'}"
Lá bài Quá khứ: ${state.drawnCards[0]}
Lá bài Hiện tại: ${state.drawnCards[1]}
Lá bài Tương lai: ${state.drawnCards[2]}

Yêu cầu:
- Diễn giải ý nghĩa của từng lá bài trong vị trí của nó (quá khứ, hiện tại, tương lai).
- Liên kết ý nghĩa của ba lá bài để tạo thành một câu chuyện có ý nghĩa, trả lời cho câu hỏi của người dùng.
- Đưa ra lời khuyên mang tính xây dựng.
- Trả về kết quả dưới dạng JSON thuần túy (không markdown):
{
  "cards": [
    {"name": "${state.drawnCards[0]}", "position": "Quá khứ", "interpretation": "Diễn giải chi tiết ý nghĩa lá bài trong vị trí Quá khứ..."},
    {"name": "${state.drawnCards[1]}", "position": "Hiện tại", "interpretation": "Diễn giải chi tiết ý nghĩa lá bài trong vị trí Hiện tại..."},
    {"name": "${state.drawnCards[2]}", "position": "Tương lai", "interpretation": "Diễn giải chi tiết ý nghĩa lá bài trong vị trí Tương lai..."}
  ],
  "summary": "Tổng hợp ý nghĩa của toàn bộ trải bài và đưa ra lời khuyên cuối cùng cho người hỏi."
}`;
                parts.push({ text: prompt });
            } else if (state.mode === 'single') {
                prompt = `Bạn là một AI chuyên gia về nhân tướng học. Dựa trên các nguyên tắc nhân tướng học cổ truyền, hãy phân tích kỹ lưỡng khuôn mặt trong ảnh. Yêu cầu:
- Phân tích một cách nghiêm túc, chi tiết và khách quan.
- Đánh giá các bộ phận trên khuôn mặt (trán, mắt, mũi, miệng) và liên hệ chúng với các khía cạnh về trí tuệ, thần thái, tài lộc và tính cách.
- Đưa ra những dự đoán và lời khuyên xác đáng về sự nghiệp và tình duyên.
- Trả về kết quả dưới dạng JSON thuần túy (không dùng markdown).
Cấu trúc JSON như sau:
{
  "forehead": "Nhận xét chi tiết về vầng trán và liên hệ với trí tuệ, tiền vận.",
  "eyes": "Phân tích thần thái của đôi mắt, liên hệ với tâm hồn và vận khí.",
  "nose": "Đánh giá hình dáng mũi, liên hệ tới tài lộc và trung vận.",
  "mouth": "Luận giải về khuôn miệng, liên hệ tới tính cách và hậu vận.",
  "career": "Dự đoán và đưa ra lời khuyên về con đường sự nghiệp.",
  "love": "Dự đoán và đưa ra lời khuyên về đường tình duyên.",
  "score": 85
}
Nếu không có mặt trong ảnh, trả về: {"error": "Không thể phát hiện khuôn mặt trong ảnh. Vui lòng sử dụng ảnh chụp chính diện và rõ nét."}`;
                parts.push({ text: prompt });
                parts.push({ inlineData: { mimeType: mime1, data: b64Img1 } });
            } else { // couple
                prompt = `Bạn là một AI chuyên gia về nhân tướng học, chuyên phân tích tướng phu thê. Dựa trên các nguyên tắc nhân tướng học, hãy phân tích sự hòa hợp giữa hai người trong ảnh. Yêu cầu:
- Phân tích một cách nghiêm túc và khách quan.
- So sánh các đặc điểm trên khuôn mặt của hai người để tìm ra điểm tương đồng (tướng phu thê) và khác biệt.
- Đánh giá mức độ hòa hợp và các điểm có thể gây xung đột trong mối quan hệ.
- Đưa ra lời khuyên xây dựng để giúp cặp đôi hòa hợp hơn.
- Trả về kết quả dưới dạng JSON thuần túy (không dùng markdown).
Cấu trúc JSON như sau:
{
  "compatibility_score": 90,
  "overview": "Một câu nhận xét tổng quan, chuyên môn về mức độ đẹp đôi và hòa hợp.",
  "harmony_points": "Phân tích những điểm tương đồng, hòa hợp trên khuôn mặt tạo nên tướng phu thê.",
  "conflict_points": "Phân tích những điểm khác biệt, có thể dẫn đến bất đồng và cách khắc phục.",
  "love_advice": "Lời khuyên chuyên môn để xây dựng mối quan hệ bền vững.",
  "future_prediction": "Dự đoán về tương lai của mối quan hệ dựa trên phân tích."
}
Nếu ảnh lỗi hoặc thiếu mặt: {"error": "Vui lòng chọn ảnh rõ mặt của cả hai người để có kết quả phân tích chính xác nhất."}`;
                parts.push({ text: prompt });
                parts.push({ inlineData: { mimeType: mime1, data: b64Img1 } });
                parts.push({ inlineData: { mimeType: mime2, data: b64Img2 } });
            }

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts }] })
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResult) throw new Error("Không nhận được phản hồi.");

                const cleanJson = textResult.replace(/```json|```/g, '').trim();
                const parsedResult = JSON.parse(cleanJson);

                if (parsedResult.error) {
                    state.error = parsedResult.error;
                    state.isScanning = false;
                    state.isDrawing = false;
                } else {
                    if (state.mode === 'tarot') {
                        state.tarotResult = parsedResult;
                        state.isDrawing = false;
                    } else {
                        state.scanProgress = 100;
                        setTimeout(() => {
                            state.result = parsedResult;
                            state.isScanning = false;
                            render();
                        }, 500);
                    }
                }

            } catch (err) {
                console.error(err);
                const defaultError = state.mode === 'tarot'
                    ? "AI đang bận, không thể giải bài lúc này. Xin thử lại sau."
                    : "AI đang quá tải hoặc không thể phân tích. Thử lại sau nhé.";
                state.error = defaultError;
                state.isScanning = false;
                state.isDrawing = false;
            } finally {
                render();
            }
        };

        const resetApp = () => {
            // Reset face reading state
            state.imageFile1 = null;
            state.imageFile2 = null;
            state.result = null;
            state.scanProgress = 0;
            state.isScanning = false;
            // Reset tarot state
            state.tarotQuestion = '';
            state.drawnCards = [];
            state.tarotResult = null;
            state.isDrawing = false;
            // Reset common state
            state.error = null;
            render();
        };

        const switchMode = (newMode) => {
            if (state.mode !== newMode) {
                state.mode = newMode;
                resetApp(); // Full reset on mode switch
            }
        };

        // --- EVENT LISTENERS ---
        singleModeBtn.addEventListener('click', () => switchMode('single'));
        coupleModeBtn.addEventListener('click', () => switchMode('couple'));
        tarotModeBtn.addEventListener('click', () => switchMode('tarot'));
        resetBtn.addEventListener('click', resetApp);
        fileInput1.addEventListener('change', (e) => handleImageUpload(e, 1));
        fileInput2.addEventListener('change', (e) => handleImageUpload(e, 2));

        // --- INITIAL RENDER ---
        document.addEventListener('DOMContentLoaded', render);

    </script>
</body>
</html>
